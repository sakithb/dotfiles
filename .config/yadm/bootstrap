#!/usr/bin/env bash

set -euo pipefail

run_or_fail() {
    local error_msg="$1"
    shift
    if ! "$@" ; then
        echo "$error_msg"
        exit 1
    fi
}

ask() {
    read -p "$1 (y/n)? " ANSWER
    [[ "$ANSWER" == "y" ]]
}

if [ "$EUID" -eq 0 ] && ! ask "Was running this script as root intentional"; then
  exit
fi

echo "=== Setup ==="

# Install yay

git clone https://aur.archlinux.org/yay.git "/tmp/yay"
pushd /tmp/yay
makepkg -si --noconfirm --clean --cleanbuild --rmdeps
popd
rm -rf /tmp/yay

# Install packages

yay -S --needed \
    --noconfirm --sudoloop \
    --cleanafter --removemake \
    - < "$HOME/.config/yadm/packages.list"

# Install enable services

systemctl --user enable \
    waybar.service mako.service swww.service swayidle.service \
    clipboard-history-watcher.service fuzzel-polkit-agent.service udiskie.service \
    battery-level-watcher.timer wallpaper-slideshow.timer

# System level config files

sudo mkdir -p /etc/keyd
sudo ln -sf "$HOME/.config/yadm/etc-keyd-default.conf" /etc/keyd/default.conf

# Install packages needing manual intervention

pushd /tmp/
yay -G cmd-polkit-git
pushd /tmp/cmd-polkit-git
patch -u "PKGBUILD" -i "$HOME/.config/yadm/cmd-polkit-git-PKGBUILD.patch"
makepkg -si --noconfirm --clean --cleanbuild --rmdeps
popd
popd

# Setup environment

mkdir -p "$HOME/projects"/{personal,work,other}
mkdir -p "$HOME"/{downloads,videos}

git config --global user.email "pvsakith@gmail.com"
git config --global user.name "Sakith B."

echo "=== Setup complete ==="

if ask "Setup GPG and SSH"; then
    echo "=== SSH and GPG ==="

    read -p "Enter github token: " TOKEN

    run_or_fail "Failed to import gpg public key" gpg --quiet --batch --yes \
        --keyserver hkps://keys.openpgp.org \
        --recv-keys 1B9C83430CA29B0B07680C0FBCF3B451C3CA33C2

    run_or_fail "Failed to import gpg private key" curl -s -f \
        -H "Authorization: token $TOKEN" \
        -H "Accept: application/vnd.github.raw" \
        "https://api.github.com/repos/sakithb/dotsecrets/contents/gpg-private-keys.asc.gpg" \
        | gpg --quiet --decrypt | gpg --quiet --import

    echo "GPG keys imported successfully"

    export GPG_TTY=$(tty)
    export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
    gpgconf --kill gpg-agent

    sudo pacman -S openssh --needed --noconfirm

    yadm remote set-url origin "git@github.com:sakithb/dotfiles.git"
    yadm submodule update --init --remote "$HOME/.secrets"

    echo "=== SSH and GPG complete ==="
fi

if ask "Setup secure boot"; then
    echo "=== Secure boot ==="

    if [[ "$(sbctl status --json | jq '.setup_mode')" = "true" ]]; then
        sudo sbctl create-keys
        sudo sbctl enroll-keys -m

        sudo sbctl verify --json \
                | jq '.[].file_name | select(. != "/boot/EFI/systemd/systemd-bootx64.efi")' \
                | xargs sudo sbctl sign -s

        sudo sbctl sign -s \
            -o /usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed \
            /usr/lib/systemd/boot/efi/systemd-bootx64.efi
    else
        echo "Please enter setup mode and retry"
        exit
    fi

    echo "=== Secure boot complete ==="
fi
